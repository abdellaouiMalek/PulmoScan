{% extends 'dashboard/dashboard_base.html' %}

{% block title %}PulmoScan - Analyze an Image{% endblock %}

{% block page_title %}Analyze an Image{% endblock %}

{% block dashboard_content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 mb-4">
            <i class="fas fa-upload me-2"></i> Analyze an Image
        </h1>
        <p class="lead">
            Upload a lung scan image to analyze it with our EfficientNetB7 model.
        </p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">Upload an Image</h5>

                <div id="upload-container">
                    <!-- Simplified upload form -->
                    <form id="upload-form" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="file-input" class="form-label">Select a lung scan image</label>
                            <input type="file" id="file-input" class="form-control" accept="image/*">
                            <div class="form-text">Accepted formats: JPG, PNG, BMP, etc.</div>
                        </div>

                        <div id="preview-container" class="text-center mb-4 d-none">
                            <h5>Image Preview</h5>
                            <img id="image-preview" class="img-fluid img-thumbnail mb-3" style="max-height: 300px;">
                        </div>

                        <div class="text-center">
                            <button type="button" id="analyze-btn" class="btn btn-primary btn-lg" disabled>
                                <i class="fas fa-microscope me-2"></i> Analyze Image
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="text-center py-5 d-none">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="mt-3">Analyzing image...</h5>
                    <p class="text-muted">This may take a few moments</p>
                </div>

                <!-- Results Container -->
                <div id="result-container" class="d-none">
                    <div class="text-center mb-4">
                        <h4 class="mb-3">Analysis Results</h4>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> Results are for demonstration purposes only. Always consult with a medical professional.
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Uploaded Image</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img id="result-image" class="img-fluid img-thumbnail" style="max-height: 300px;">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Diagnosis</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table">
                                        <tbody>
                                            <tr>
                                                <th>Result:</th>
                                                <td id="result-diagnosis"></td>
                                            </tr>
                                            <tr>
                                                <th>Probability:</th>
                                                <td id="result-probability"></td>
                                            </tr>
                                            <tr>
                                                <th>Date:</th>
                                                <td id="result-date"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <button id="new-analysis-btn" class="btn btn-outline-primary">
                            <i class="fas fa-plus-circle me-2"></i> New Analysis
                        </button>
                        <a href="{% url 'results' %}" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-history me-2"></i> View History
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script>
    $(document).ready(function() {
        const fileInput = $('#file-input');
        const previewContainer = $('#preview-container');
        const imagePreview = $('#image-preview');
        const analyzeBtn = $('#analyze-btn');
        const uploadContainer = $('#upload-container');
        const loadingSpinner = $('#loading-spinner');
        const resultContainer = $('#result-container');
        const resultContent = $('#result-content');
        const newAnalysisBtn = $('#new-analysis-btn');

        // Handle file input change
        fileInput.on('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.attr('src', e.target.result);
                    previewContainer.removeClass('d-none');
                    analyzeBtn.prop('disabled', false);
                }
                reader.readAsDataURL(file);
            } else {
                previewContainer.addClass('d-none');
                analyzeBtn.prop('disabled', true);
            }
        });

        // Handle analyze button click
        analyzeBtn.on('click', function() {
            // Show loading spinner
            uploadContainer.addClass('d-none');
            loadingSpinner.removeClass('d-none');

            // Create form data
            const formData = new FormData();
            formData.append('image', fileInput[0].files[0]);
            formData.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());

            // Send AJAX request
            $.ajax({
                url: '/api/analyze/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log('API response received:', response);
                    loadingSpinner.addClass('d-none');
                    resultContainer.removeClass('d-none');

                    // Display results
                    $('#result-image').attr('src', response.image_url);
                    $('#result-diagnosis').html(
                        response.is_malignant ?
                        '<span class="result-malignant"><i class="fas fa-exclamation-triangle me-1"></i> Malignant</span>' :
                        '<span class="result-benign"><i class="fas fa-check-circle me-1"></i> Benign</span>'
                    );
                    $('#result-probability').text((response.prediction * 100).toFixed(2) + '%');

                    // Format date
                    const date = new Date(response.created_at);
                    const formattedDate = date.toLocaleDateString('en-US') + ' ' + date.toLocaleTimeString('en-US');
                    $('#result-date').text(formattedDate);
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    loadingSpinner.addClass('d-none');
                    uploadContainer.removeClass('d-none');
                    alert('An error occurred while analyzing the image. Please try again.');
                }
            });
        });

        // Handle new analysis button click
        newAnalysisBtn.on('click', function() {
            resultContainer.addClass('d-none');
            uploadContainer.removeClass('d-none');
            fileInput.val('');
            previewContainer.addClass('d-none');
            analyzeBtn.prop('disabled', true);
        });
    });
</script>
{% endblock %}
